<% layout("/layouts/boilerplate") %>
<div class="row justify-content-center my-5">
  <div class="col-lg-8 col-md-10">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
      <!-- Updated show page image section -->
      <% if (listing.image && listing.image.url) { %>
      <img
        src="<%= listing.image.url %>"
        alt="<%= listing.title %>"
        class="card-img-top"
        style="object-fit: cover; height: 350px"
        onerror="this.src='https://placehold.co/800x350?text=No+Image+Available'"
      />
      <% } else { %>
      <img
        src="https://placehold.co/800x350?text=No+Image+Available"
        alt="No Image"
        class="card-img-top"
        style="object-fit: cover; height: 350px"
      />
      <% } %>
      <div class="card-body p-4">
        <!-- Heading -->
        <h3 class="text-center fw-bold mb-4" style="color: #fe424d">
          Listing Details
        </h3>
        <!-- Listing Info -->
        <p class="text-center fw-bold mb-3" style="color: #fe424d">
          Owned by <%= listing.owner.username %>
        </p>
        <ul class="list-group list-group-flush mb-4">
          <li class="list-group-item">
            <strong style="color: #fe424d">Title:</strong> <%= listing.title %>
          </li>
          <li class="list-group-item">
            <strong style="color: #fe424d">Description:</strong> <%=
            listing.description %>
          </li>
          <li class="list-group-item">
            <strong style="color: #fe424d">Price:</strong> ₹ <%= (listing.price
            || 0).toLocaleString("en-IN") %>
          </li>
          <li class="list-group-item">
            <strong style="color: #fe424d">Location:</strong> <%=
            listing.location %>
          </li>
          <li class="list-group-item">
            <strong style="color: #fe424d">Country:</strong> <%= listing.country
            %>
          </li>
        </ul>
        <!-- Actions -->
        <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
        <div class="d-flex justify-content-center gap-3 mb-4">
          <a href="/listings/<%= listing._id %>/edit" class="btn-custom"
            >Edit Listing</a
          >
          <form
            method="POST"
            action="/listings/<%= listing._id %>?_method=DELETE"
          >
            <button type="submit" class="btn-custom">Delete Listing</button>
          </form>
        </div>
        <% } %> <% if(currUser){%>
        <!-- Review Section -->
        <div class="border-top pt-4 mt-4">
          <h4 class="text-center fw-bold mb-4" style="color: #fe424d">
            Leave a Review
          </h4>
          <form
            action="/listings/<%= listing._id %>/reviews"
            method="POST"
            novalidate
            class="needs-validation"
          >
            <div class="col-12">
              <label
                for="rating"
                class="form-label fw-semibold"
                style="color: #fe424d"
              >
                Rating
              </label>
              <input
                type="range"
                class="form-range"
                id="rating"
                name="review[rating]"
                min="1"
                max="5"
                value="3"
                required
              />
              <div class="d-flex justify-content-between small text-muted">
                <span>1</span>
                <span>2</span>
                <span>3</span>
                <span>4</span>
                <span>5</span>
              </div>
            </div>
            <div class="col-12">
              <label
                for="comment"
                class="form-label fw-semibold"
                style="color: #fe424d"
              >
                Comment
              </label>
              <textarea
                class="form-control"
                id="comment"
                name="review[comment]"
                rows="4"
                placeholder="Share your experience..."
                style="resize: none"
                required
              ></textarea>
              <div class="invalid-feedback">
                Please add some comments for review
              </div>
            </div>
            <br />
            <div class="col-12 text-center">
              <button type="submit" class="btn-custom">Submit Review</button>
            </div>
          </form>
          <% } %>
          <!-- All Reviews Section -->
          <div class="border-top pt-4 mt-4">
            <h4 class="text-center fw-bold mb-4" style="color: #fe424d">
              All Reviews
            </h4>
            <% if (listing.reviews && listing.reviews.length > 0) { %>
            <div class="row">
              <% for(review of listing.reviews) { %>
              <div class="col-lg-6 col-md-12 mb-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body p-3">
                    <!-- ✅ IMPROVED: Clean header with author info and delete button -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="d-flex align-items-center flex-wrap">
                        <span
                          class="badge rounded-pill me-2 mb-1"
                          style="background-color: #fe424d; font-size: 0.85rem; padding: 0.4rem 0.8rem"
                        >
                          <%= review.rating %> ★
                        </span>
                        <div class="author-info">
                          <h6 class="fw-bold mb-1" style="color: #fe424d; font-size: 0.95rem">
                            <%= review.author.username %>
                          </h6>
                          <small class="text-muted d-block" style="font-size: 0.8rem">
                            <%= new Date(review.createdAt).toLocaleDateString('en-IN') %>
                          </small>
                        </div>
                      </div>
                      
                      <!-- ✅ IMPROVED: Better positioned delete button -->
                      <form
                        method="POST"
                        action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                        class="d-inline"
                      >
                        <button
                          type="submit"
                          class="btn btn-sm shadow-sm"
                          style="
                            background-color: #fe424d;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 28px;
                            height: 28px;
                            padding: 0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.75rem;
                          "
                          title="Delete Review"
                        >
                          ✕
                        </button>
                      </form>
                    </div>
                    
                    <!-- ✅ IMPROVED: Better comment styling -->
                    <div class="review-comment">
                      <p
                        class="card-text mb-0 fst-italic"
                        style="
                          font-size: 0.95rem; 
                          line-height: 1.6;
                          color: #555;
                          padding: 0.75rem;
                          background-color: #f8f9fa;
                          border-left: 3px solid #fe424d;
                          border-radius: 0 0.375rem 0.375rem 0;
                        "
                      >
                        "<%= review.comment %>"
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <% } %>
            </div>
            <% } else { %>
            <div class="text-center py-5">
              <div class="text-muted">
                <i
                  class="fas fa-star-o"
                  style="font-size: 3rem; color: #fe424d; opacity: 0.3"
                ></i>
                <p class="mt-3 mb-1 fw-semibold" style="font-size: 1.1rem">No reviews yet</p>
                <small style="color: #666">Be the first to share your experience!</small>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

